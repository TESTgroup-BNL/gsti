---
title: "How to add your dataset?"
output: md_document
date: "2024-06-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This guide provides a comprehensive overview of all the necessary steps to add a new dataset. The folder "Lamour_et_al_2021" can be used as a template since the code within the folder has been commented and corresponds to each step outlined in this guide.

An overview of the process and database organization is presented [here](https://github.com/TESTgroup-BNL/gsti/blob/main/Overal_data_curation.pdf).


## Creation of a Dataset folder

Each dataset should be put into a folder named "Names_Year" for example "Serbin_et_al_2019". 
Please, also include any article associated with the dataset and the protocol of measurement, which should detail the gas exchange measurements, leaf reflectance measurements, as well as the equipment used. The protocol should also provide information about the location, growing conditions (e.g., natural environment, greenhouse, agricultural or experimental field, plants in pots), species (e.g., natural or agricultural), and plant status (e.g., stressed or not stressed).


In addition, please include details about your stability criterion to initiate the A-Ci curves. For example, did you wait for stability of the photosynthesis rate and stomatal conductance before starting the curve? What was the average acclimation time of the leaf within the leaf chamber? Also include this information if you used the "one point method" to estimate Vcmax (De Kauwe et al. 2016, Burnett et al. 2019).



## Adding a dataset description csv file

Within each dataset folder, a csv file called **Description.csv** has to be included. 

This file will be used to list the authors, associated papers, and acknowledgements.


```{r}
Description=read.csv(file='Description.csv')
knitr::kable(Description)
```

## Adding a site description csv file

A file named **Site.csv** must be included in the dataset folder with the columns listed below. The latitude and longitude coordinates will be used to position the dataset on a world map.


If you have different sites for the same dataset with wide difference in positions that makes a difference on a world map or if this includes different biomes, you can add several rows to your Site.csv file.

```{r}
Site=read.csv(file='Site.csv')
knitr::kable(Site)
```


For the Biome_number column, please chose a number within the list below. We chose to use the Olson et al. (2001) list of 14 natural Biomes that we complemented with agricultural and managed biomes. 

```{r}
Biomes=read.csv(file='Biomes.csv')
knitr::kable(Biomes)
```



## Adding the gas exchange A-C<sub>i</sub> data to the dataset folder

The aim of this project is to include the raw A-C<sub>i</sub> data so that we can fit the curves and estimate V<sub>cmax</sub> using the same method for all datasets.

The final A-C<sub>i</sub> data to be used by the fitting procedure must meet certain requirements (see table below with the required column names). However, we don't have hard requirements in the way to obtain this final data. Note that the SampleID_num column will be used by the fitting procedure to identify individual A-C<sub>i</sub> curves. If you made several A-C<sub>i</sub> curves on the same leaf we recommend to only keep the best one. We decided to use a column SampleID_num in addition to the SampleID column. SampleID should correspond to the original identifier of the leaves in the raw dataset which is often a complex string. The column SampleID_num should be an integer. We made the choice to use the SampleID_num to facilitate the QAQC of the curves and the ploting of the figures. 

The A-C<sub>i</sub> data should be cleaned from spurious measurements and points that would bias V<sub>cmax</sub> or J<sub>max</sub> estimation should not be included. If several measurements were taken at a given Ci, please only chose one so each Ci has the same number of measurements. We are usually quite conservative on the quality analysis and only keep the curves where the estimation of V<sub>cmax</sub> will be good. If we have doubts on the quality of the data we tend to remove them from the final curated data.

The curated A-C<sub>i</sub> data should be present in the dataset folder in a Rdata format called **'2_Fitted_ACi_data.Rdata'** which contains the A-C<sub>i</sub> data in a data.frame with at least the columns listed in the table below.

Note that we include in the dataset folder the raw data, as well as the R code used to read, import and transform the raw data. All those preliminary steps are made in two R codes called **'0_Import_transform_ACi_data.R'** and **'1_QaQc_curated_ACi.R'**. 


```{r}
Aci_data=read.csv(file='Aci_data.csv')
knitr::kable(Aci_data)
```


## Fitting the A-C<sub>i</sub> data to estimate the photosynthetic traits

Estimation of V<sub>cmax</sub> is done in the **'2_Fit_ACi.R'** code included in each dataset folder.
This code calls the function f.fit_Aci() to estimate the photosynthetic parameters V<sub>cmax25</sub>, J<sub>max25</sub>, TPU<sub>25</sub> and R<sub>day25</sub> of the A-C<sub>i</sub> curve.  It produces several pdf files:

-   2_ACi_fitting_Ac.pdf

-   2_ACi_fitting_Ac_Aj.pdf

-   2_ACi_fitting_Ac_Aj_Ap.pdf

and

-   2_ACi_fitting_best_model.pdf

The first three pdf show the fitting of each A-C<sub>i</sub> curves when including the rate of maximum carboxylation (A<sub>c</sub>), the rate of electron transport (A<sub>j</sub>) and the rate of triose phosphate utilization (A<sub>p</sub>).

The best model corresponds to the model with the lowest AIC that includes A<sub>c</sub> or A<sub>c</sub> + A<sub>j</sub> or A<sub>c</sub> + A<sub>j</sub> + A<sub>p</sub>. Note that if the model with the best AIC is the one including A<sub>c</sub> only, then V<sub>cmax25</sub> and R<sub>day25</sub> are the only parameters estimated. If the model with the best AIC is A<sub>c</sub> + A<sub>j</sub>, then J<sub>max25</sub> is also estimated. TPU<sub>25</sub> is estimated if A<sub>c</sub>, A<sub>j</sub> and A<sub>p</sub> are limiting. In all cases, transition between the A<sub>c</sub>, A<sub>j</sub>, and A<sub>p</sub> rates is determined automatically by the fitting procedure to avoid manual and somehow subjective choices in the transitions.

This codes produces a dataframe, called Bilan with the following columns: 

```{r}
Bilan=read.csv(file='Bilan.csv',header = TRUE)
knitr::kable(Bilan)
```

It is also possible to estimate V<sub>cmax25</sub> by the one point method (De Kauwe et al. 2016; Burnett et al. 2019).In that case, the measurements should be done at saturating irradiance in ambient CO<sub>2</sub> conditions. You can use the function f.fit_One_Point() to estimate V<sub>cmax25</sub>. It will produce the exact same data frame as when using the function f.fit_Aci.


Importantly, the same temperature correction is used for all the datasets to estimate the parameters at 25°C. Since the Tleaf is also given in the output of the table, it will be possible to re estimate the parameters at the leaf temperature and to try other temperature dependence parametrization if needed. The A-C<sub>i</sub> fitting can also be re-run with different parametrizations for all the datasets using the output from step 1.


## Adding dark adapted leaf respiration data (optional)

If you measured the dark respiration of leaves you can also add them to the dataset. All you need is to include a file with as columns:

- SampleID (the leaf identifier that is used everywhere to link different data)
- Rdark (the dark respiration value, in micromol m-2 s-1, which corresponds to the CO2 release from the leaf in the dark, at measurement temperature, reported as a positive value)
- Tleaf_Rdark, in degree celcius, the measurement leaf temperature


## Adding the leaf spectra data

The spectral information is ideally a full range reflectance measurement (350 nm to 2500 nm) with a 1 nm resolution.

If you don't have values for all the wavelengths (for example from 350 nm to 500 nm or from 2400 nm to 2500 nm), you can put NA in those wavelengths. 

A code **"3_Import_transform_Reflectance.R"** should be used to create a R data frame file called **"3_QC_Reflectance_data.Rdata"** with four columns:

-   SampleID which has to be consistent with the previous files for each leaf,

-   Spectrometer, the spectrometer model used (SE PSR+ 3500, SVC HR-1024i, SVC XHR-1024i, ASD FieldSpec 3, ASD FieldSpec 4, ASD FieldSpec 4 Hi-Res, ...)

-   Probe_type, the type of probe (Integrating sphere, Leaf clip, Imager)

-   Probe_model, the reference of the probe model (SVC LC-RP, SVC LC-RP Pro, ASD Leaf Clip, ...)

-   Spectra_trait_pairing, a column that explains how the gas exchange information is paired with the spectral data. If the gas exchange and leaf spectra were measured in the same leaf, chose "Same".     If they were measured in similar leaves, chose "Similar". Finally, if hyperspectral data was measured at the plant scale (and paired to gas exchange at the leaf scale), chose "Plant scale".

-   Reflectance, which is a matrix with the Reflectance in column expressed in percent from 0 to 100.

We use a matrix in the column Reflectance, following the "pls" package requirement (Mevik & Wehrens, 2007). More information is given in the "pls" package documentation and manual (https://cran.r-project.org/web/packages/pls/vignettes/pls-manual.pdf)

Bjørn-Helge Mevik and Ron Wehrens. The pls package: Principal component and partial
least squares regression in R. Journal of Statistical Software, 18(2):1–24, 2007.

### Adding a leaf sample information description csv file

A code called **"4_Import_transform_SampleDetails.R"** should be used to create a **'SampleDetails'** dataframe with the following columns: 


```{r}
SampleDetails=read.csv(file='SampleDetails.csv')
knitr::kable(SampleDetails)
```

Importantly, the Site_name has to be consistent with the Site_name written in the Site.csv file and the SampleID will have to be consistent with the identifier used for the gas exchange and for the spectra as the SampleID will be used to merge all the different data.

The first columns have to be filled (SampleID, Dataset_name, Site_name, Species, Sun_Shade, Phenological_stage, Plant_type, Soil), the columns related to the leaf traits can be left empty if you don't have the data (LMA, Narea, Nmass, Parea, Pmass, LWC). Note that the leaf water content, LWC, corresponds to (fresh weight - dry weight) / fresh weight.

For the species name, please write "Genus species", for exemple Cercropia insignis. If you know the genus but not the species, write for example "Cecropia species". If you dont know the genus, write "Family genus" for example (Urticaceae genus). If you don't know anything, well you can write "Unknown".

The SampleDetails dataframe is stored in the Rdata file **'4_SampleDetails.Rdata'**.


## Checking the overall dataset information

The function "f.Check_data()" can be used to validate that the format of the curated dataset is correct and that all the required files are provided. The function checks if required variables are present in the data files and if all the information can be merged together.

This function is called in the last R file "4_Import_transform_SampleDetails.R"


### References


Burnett, AC, Davidson, KJ, Serbin, SP, Rogers, A. The “one-point method” for estimating maximum carboxylation capacity of photosynthesis: A cautionary tale. Plant Cell Environ. 2019; 42: 2472– 2481. https://doi.org/10.1111/pce.13574

De Kauwe, M. G., Lin, Y. S., Wright, I. J., Medlyn, B. E., Crous, K. Y., Ellsworth, D. S., … Domingues, T. F. (2016b). A test of the “one-point method” for estimating maximum carboxylation capacity from field-measured, light-saturated photosynthesis. New Phytologist, 210(3), 1130– 1144. https://doi.org/10.1111/nph.13815

David M. Olson, Eric Dinerstein, Eric D. Wikramanayake, Neil D. Burgess, George V. N. Powell, Emma C. Underwood, Jennifer A. D'amico, Illanga Itoua, Holly E. Strand, John C. Morrison, Colby J. Loucks, Thomas F. Allnutt, Taylor H. Ricketts, Yumiko Kura, John F. Lamoreux, Wesley W. Wettengel, Prashant Hedao, Kenneth R. Kassem, Terrestrial Ecoregions of the World: A New Map of Life on Earth: A new global map of terrestrial ecoregions provides an innovative tool for conserving biodiversity, BioScience, Volume 51, Issue 11, November 2001, Pages 933–938, https://doi.org/10.1641/0006-3568(2001)051[0933:TEOTWA]2.0.CO;2