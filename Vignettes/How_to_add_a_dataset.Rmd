---
title: "How to add your dataset?"
output: md_document
date: "2022-09-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Creation of a Dataset folder

Each dataset is put into a folder called "Names_Year" for example "Serbin_et_al_2019". 
Please, also add any article associated with the dataset or the protocol of measurement, which should include the description of the gas exchange measurements, leaf reflectance measurements, as well as the equipments used. It should also include the location description, information on the growing conditions (Natural environment? Green house? Agricultural or experimental field? Plants in pots?) and information on the species (Natural species, agricultural species) as well as the status of the plants (stressed, not stressed?)

### Adding a dataset description csv file

In each dataset folder a csv file called Description.csv has to be included. 
An example is given in the Folder 0_Template. This file will be used to list the authors as well as associated papers and acknoledgements.


```{r}
Description=read.csv(file='Description.csv')
knitr::kable(Description)
```

### Adding a site description csv file

A file called Site.csv also has to be included with the column listed below.The latitude and longitude coordinates will be used to position the dataset on a world map.
If you have different sites on the same dataset with wide difference in positions that makes a difference on a world map or if this include different biomes, you can add several rows to your Site.csv file.

```{r}
Site=read.csv(file='Site.csv')
knitr::kable(Site)
```

For the Biome_number column, please chose a number among the list below. We chose to use the Olson et al. (2001) list of 14 natural Biomes that we complemented with agricultural and managed biomes. 

```{r}
Biomes=read.csv(file='Biomes.csv')
knitr::kable(Biomes)
```

### Adding a leaf sample information description csv file

A file called SampleDetails.csv also has to be included with at the column listed below. More columns can be added if necessary.
Importantly, the Site_name has to be consistent with the Site_name written in the Site.csv file and the SampleID will have to be consistent with the identifier used for the gas exchange and for the spectra as the SampleID will be used to merge all the different data.

The columns LMA, Narea and LWC do not necessary need to be filled if you don't have the data.

For the species name, please write "Genus species", for exemple Cercropia insignis. If you know the genus but not the species, write for example "Cecropia species". If you dont know the genus, write "Family genus" for example (Urticaceae genus). If you don't know anything, well you can write "Unknown".


You can use a R code or another way to create this file. If you use a R code, we recommend to leave it within the dataset folder and to call it "Import_transform_SampleDetails.R".

```{r}
Biomes=read.csv(file='SampleDetails.csv')
knitr::kable(Biomes)
```


## Adding the gas exchange A-C<sub>i</sub> data to the dataset folder

The idea of this project is to include the raw A-C<sub>i</sub> data so we can fit the curves and estimate V<sub>cmax</sub> using the same method for all datasets.

We have requirements for the final A-C<sub>i</sub> data to be used by the fitting procedure (see table below with the needed column names). However, we don't have hard requirements in the way to obtain this final data. Note that the SampleID_num column will be used by the fitting procedure to identify individual A-C<sub>i</sub> curves. If you made several A-C<sub>i</sub> curves on the same leaf we recommend to only keep the best one. We decided to use a column SampleID and a column SampleID_num. SampleID should correspond to the original identifier of the leaves in the raw dataset which is often a complex string. The column SampleID_num should be an integer. We made the choice to use the SampleID_num to facilitate the QAQC of the curves and the ploting of the figures (title name). 

The A-C<sub>i</sub> data should be cleaned from spurious measurements and points that would impact V<sub>cmax</sub> or J<sub>max</sub> estimation should not be included. If several measurements were taken at a given Ci, please only chose one so each Ci has the same number of measurements.We are usually quite severe on the quality analysis to only keep the curves where the estimation of V<sub>cmax</sub> will be good. If we have doubts on the quality of the data we tend to remove them from the final curated data.

The curated A-C<sub>i</sub> data should be present in the dataset folder in a Rdata format called 'QC_ACi_data.Rdata' which contains the A-C<sub>i</sub> data in a data.frame with at least the columns listed in the table below.

Note that we usually include in the dataset folder the raw data, as well as the R code used to read, import and transform the raw data. All those preliminary steps are made in a R code called 'Import_transform_ACi.R'.We recommend to do the same, but again, we don't have requirements on the code to do that.


```{r}
Aci_data=read.csv(file='Aci_data.csv')
knitr::kable(Aci_data)
```



## Fitting the A-C<sub>i</sub> data to estimate the photosynthetic traits

Estimation of V<sub>cmax</sub> is done in the 'Fit_ACi.R' code included in each dataset folder.
This code calls the function f.fit_Aci() to estimate the photosynthetic parameters V<sub>cmax25</sub>, J<sub>max25</sub>, TPU<sub>25</sub> and R<sub>day25</sub> of the A-C<sub>i</sub> curve.  It produces several pdf files:

-   2_ACi_fitting_Ac.pdf

-   2_ACi_fitting_Ac_Aj.pdf

-   2_ACi_fitting_Ac_Aj_Ap.pdf

and

-   2_ACi_fitting_best_model.pdf

The first three pdf shows the fitting of each A-C<sub>i</sub> curves when including the rate of maximum carboxylation (A<sub>c</sub>), the rate of electron transport (A<sub>j</sub>) and the rate of triose phosphate utilisation (A<sub>p</sub>).

The best model corresponds to the model with the lowest AIC that includes A<sub>c</sub> or A<sub>c</sub> + A<sub>j</sub> or A<sub>c</sub> + A<sub>j</sub> + A<sub>p</sub>. Note that if the models with the best AIC is the one only including A<sub>c</sub>, then V<sub>cmax25</sub> and R<sub>day25</sub> are the only parameters estimated. If the model with the best AIC is A<sub>c</sub> + A<sub>j</sub>, then J<sub>max25</sub> is also estimated. TPU<sub>25</sub> is estimated if A<sub>c</sub>, A<sub>j</sub> and A<sub>p</sub> are limiting. In all cases, transition between the A<sub>c</sub>, A<sub>j</sub>, and A<sub>p</sub> rates is determined automatically by the fitting procedure to avoid manual and somehow subjective choices in the transitions.

This codes produces a dataframe, called Bilan which includes the folowing column: 

```{r}
Bilan=read.csv(file='Bilan.csv',header = TRUE)
knitr::kable(Bilan)
```

It is also possible to estimate V<sub>cmax25</sub> by the one point method (De Kauwe et al. 2016; Burnett et al. 2019).
In that case, the measurements should be done at saturating irradiance in ambient CO<sub>2</sub> conditions. You can use the function f.fit_One_Point() to estimate V<sub>cmax25</sub>. It will produce the exact same data frame as when using the function f.fit_Aci.

Importantly, the same temperature correction is used for all the datasets to estimate the parameters at 25°C. Since the Tleaf is also given in the output of the table, it will be possible to re estimate the parameters at the leaf temperature and to try other temperature dependence parametrization if needed.

## Adding the leaf spectra data

The spectral information should be a full range reflectance measurement (350 nm to 2500 nm) with a 1 nm resolution
If you don't have values for all the wavelengths (for example from 350 nm to 500 nm or from 2400 nm to 2500 nm), you can put NA in those wavelengths. 

A code "Import_transform_reflectance.R" should be used to create a R data frame file called "Reflectance_data.Rdata" with two columns:

-   SampleID which has to be consistent with the previous files for each leaf,

-   Reflectance, which is a matrix with the reflectance in column (expressed in percent from 0 to 100).

We use a matrix in the column spectra as in the pls package (Mevik & Wehrens, 2007). More information is given in the "pls" package documentation and manual (https://cran.r-project.org/web/packages/pls/vignettes/pls-manual.pdf)

Bjørn-Helge Mevik and Ron Wehrens. The pls package: Principal component and partial
least squares regression in R. Journal of Statistical Software, 18(2):1–24, 2007.



## Merging the leaf information

We merge the fitted parameters, the spectra and the leaf information in the code called '4_Combine_spectra_traits.R' that produces a Rdata file called "4_Spectra_traits.Rdata".

The function "f.Check_data()" can be used to validate that the format of the data is correct (i.e that the required variables are present in the merged data and that the values are within a reasonable range).

